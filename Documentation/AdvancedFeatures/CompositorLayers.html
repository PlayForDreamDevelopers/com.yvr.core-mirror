<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
      <title>Composition Layers | Core </title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta name="title" content="Composition Layers | Core ">
      
      
      <link rel="icon" href="../../favicon.ico">
      <link rel="stylesheet" href="../../public/docfx.min.css">
      <link rel="stylesheet" href="../../public/main.css">
      <meta name="docfx:navrel" content="../../toc.html">
      <meta name="docfx:tocrel" content="../toc.html">
      
      <meta name="docfx:rel" content="../../">
      
      
      <meta name="docfx:docurl" content="https://github.com/PlayForDreamDevelopers/com.yvr.core-mirror/blob/main/com.yvr.core/Documentation/AdvancedFeatures/CompositorLayers.md/#L1">
      <meta name="loc:inThisArticle" content="In this article">
      <meta name="loc:searchResultsCount" content="{count} results for &quot;{query}&quot;">
      <meta name="loc:searchNoResults" content="No results for &quot;{query}&quot;">
      <meta name="loc:tocFilter" content="Filter by title">
      <meta name="loc:nextArticle" content="Next">
      <meta name="loc:prevArticle" content="Previous">
      <meta name="loc:themeLight" content="Light">
      <meta name="loc:themeDark" content="Dark">
      <meta name="loc:themeAuto" content="Auto">
      <meta name="loc:changeTheme" content="Change theme">
      <meta name="loc:copy" content="Copy">
      <meta name="loc:downloadPdf" content="Download PDF">

      <script type="module" src="./../../public/docfx.min.js"></script>

      <script>
        const theme = localStorage.getItem('theme') || 'auto'
        document.documentElement.setAttribute('data-bs-theme', theme === 'auto' ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') : theme)
      </script>

  </head>

  <body class="tex2jax_ignore" data-layout="" data-yaml-mime="">
    <header class="bg-body border-bottom">
      <nav id="autocollapse" class="navbar navbar-expand-md" role="navigation">
        <div class="container-xxl flex-nowrap">
          <a class="navbar-brand" href="../../index.html">
            <img id="logo" class="svg" src="../../logo.svg" alt="Core">
            Core
          </a>
          <button class="btn btn-lg d-md-none border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navpanel" aria-controls="navpanel" aria-expanded="false" aria-label="Toggle navigation">
            <i class="bi bi-three-dots"></i>
          </button>
          <div class="collapse navbar-collapse" id="navpanel">
            <div id="navbar">
              <form class="search" role="search" id="search">
                <i class="bi bi-search"></i>
                <input class="form-control" id="search-query" type="search" disabled="" placeholder="Search" autocomplete="off" aria-label="Search">
              </form>
            </div>
          </div>
        </div>
      </nav>
    </header>

    <main class="container-xxl">
      <div class="toc-offcanvas">
        <div class="offcanvas-md offcanvas-start" tabindex="-1" id="tocOffcanvas" aria-labelledby="tocOffcanvasLabel">
          <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="tocOffcanvasLabel">Table of Contents</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#tocOffcanvas" aria-label="Close"></button>
          </div>
          <div class="offcanvas-body">
            <nav class="toc" id="toc"></nav>
          </div>
        </div>
      </div>

      <div class="content">
        <div class="actionbar">
          <button class="btn btn-lg border-0 d-md-none" style="margin-top: -.65em; margin-left: -.8em" type="button" data-bs-toggle="offcanvas" data-bs-target="#tocOffcanvas" aria-controls="tocOffcanvas" aria-expanded="false" aria-label="Show table of contents">
            <i class="bi bi-list"></i>
          </button>

          <nav id="breadcrumb"></nav>
        </div>

        <article data-uid="">
<h1 id="composition-layers">Composition Layers</h1>

<p>Composition Layers can segment all objects that need to be displayed to achieve purposes such as improving the clarity of specific objects. In the most traditional rendering mode, all objects in the scene will be rendered to the same texture (Eye Buffer), which will be processed by the system for ATW, distortion, composition, and finally displayed on the device screen. By using composition layer technology, specific objects in the scene can be rendered to a texture and handed over to the system for composition, thus reducing an extra texture sampling and improving the clarity of object rendering.</p>
<p>It should be noted that composition layers are not omnipotent. Each composition layer will increase the composition overhead for the system. Therefore, when using composition layers, it is necessary to use them reasonably according to actual needs and device performance:</p>
<ul>
<li>It is recommended to use composition layers for objects that need to improve clarity, such as UI interfaces, text, etc.</li>
<li>The number of composition layers should not be too many. Generally, the number of composition layers in a single scene should be controlled to about 4 layers.</li>
<li>The depth value of the composition layer needs to be set reasonably to ensure that the content in the composition layer and the Eye Buffer will not cause incorrect occlusion effects.</li>
</ul>
<h2 id="types-of-composition-layers">Types of Composition Layers</h2>
<p>Composition layers can be divided into two types based on their type: Overlay and Underlay:</p>
<ul>
<li><strong>Overlay</strong>: The texture of the Overlay type composition layer is presented in front of the Eye Buffer by default. For objects that need to always appear in front of the Eye Buffer, such as cursors, the Overlay type composition layer can be used.</li>
<li><strong>Underlay</strong>: The texture of the Underlay type composition layer is presented behind the Eye Buffer. Since the Underlay layer relies on the alpha channel on the rendering target, after all objects in the scene are drawn to the Eye Buffer, you need to create a &quot;hole&quot; on the Eye Buffer to allow the Underlay texture to show through this &quot;hole&quot;. For objects like UI interfaces that may be occluded by other objects in the Eye Buffer (such as UI being occluded by a controller), the Underlay type composition layer can be used.</li>
</ul>
<p>The <code>composition depth</code> can be used to distinguish between Overlay and Underlay types of composition layers:</p>
<ul>
<li>The depth value of the Eye Buffer is 0.</li>
<li>The depth value of the Underlay type composition layer is less than 0.</li>
<li>The depth value of the Overlay type composition layer is greater than 0.</li>
</ul>
<h2 id="shapes-of-composition-layers">Shapes of Composition Layers</h2>
<p>The shape of the composition layer determines the display effect of the composition layer. There are three shapes of composition layers: Quad, Cylinder, and Equirect:</p>
<ul>
<li><strong>Quad</strong>: A quadrilateral plane texture with four vertices, usually used to display text or information in the scene.</li>
<li><strong>Cylinder</strong>: A cylindrical texture with a cylindrical arc, usually used to display curved UI interfaces. If using Cylinder:
<ul>
<li>The center of the Transform will be the center of the Cylinder, the size of the Transform will be the size of the Cylinder, and the size of the Transform in the Cylinder will be the global size (Global Scale). Among them, Z is the radius of the Cylinder, Y is the height of the Cylinder, and X/Z is the arc length of the Cylinder.</li>
<li>The camera must be placed inside the inscribed sphere of the cylinder. If the camera approaches the surface of the inscribed sphere, the composition layer will not be displayed.</li>
</ul>
</li>
<li><strong>Equirect</strong>: A spherical texture, usually used to display 360/180 panoramic textures.
<ul>
<li>The Radius parameter is used to specify the radius of the cylinder. When set to 0 or positive infinity (1.0f/0.0f), it indicates an infinitely large radius. When the spherical radius is infinitely large, its display effect is like a skybox in an empty scene.</li>
<li>The X parameter under Destination Rects is useless; the W parameter maps to the central angle, symmetrical about the central point coordinates (0, 0).</li>
</ul>
</li>
</ul>
<h2 id="texture-types">Texture Types</h2>
<p>The objects processed by the composition layer are textures, which can be divided into three types:</p>
<ul>
<li><strong>External Texture</strong>: The texture content is obtained from outside the Unity rendering context. In typical use cases, it is directly obtained from the Android Surface texture (e.g., Android player video texture). For scenarios such as video players, external textures need to be used.</li>
<li><strong>Dynamic Texture</strong>: The texture content will be updated at runtime, such as the RenderTexture image generated by the camera.</li>
<li><strong>Static Texture</strong>: The texture content will not be updated at runtime, such as static advertisement images in the scene.</li>
</ul>
<h2 id="textures">Textures</h2>
<p>For textures used in composition layers, the following settings can be made:</p>
<h3 id="texture-rects">Texture Rects</h3>
<p>After checking the Texture Rects checkbox, you can configure the parameters related to Source Rects and Destination Rects.</p>
<p>If you choose to customize Source Rects and Destination Rects (i.e., select the Custom option), you need to ensure that the values of X, Y, W, and H are within the specified range: X: <span class="math">\([0,1)\)</span>, Y: <span class="math">\([0,1)\)</span>, W: <span class="math">\((0,1]\)</span>, H: <span class="math">\((0,1]\)</span>.</p>
<h3 id="transparency">Transparency</h3>
<p>The <code>alpha</code> parameter is used to set the transparency of the texture, with a value range of <span class="math">\([0,1]\)</span>.</p>
<h2 id="examples">Examples</h2>
<p>The CompositeLayer scene is used to illustrate the effect of composition layers. The design of the composition layer is to improve the clarity of the flat UI. In the traditional rendering pipeline, the UI texture must first be rendered to the color buffer managed by Unity, and then the color buffer managed by Unity will be rendered to the screen buffer. When using composition layers, the target UI texture can be rendered directly by the local renderer. Therefore, distortion caused by sampling can be reduced.</p>
<p>The following is a screenshot of running the CompositeLayer scene on a YVR device:
<br>
<img src="CompositorLayers/2022-04-19-13-51-11.png" alt="Composite Layer"></p>
<div class="CAUTION">
<h5>Caution</h5>
<p>Since the composition layer is rendered by the native system of the YVR device, the content cannot be displayed in the Unity editor.</p>
</div>
<p>The lower part is the interface rendered by the Unity Eye Buffer, and the upper part is rendered by the composition layer. The left part is a dynamic texture, and the right part is a static texture.</p>
<p>The detailed differences between rendering with composition layers (upper part) and Unity Eye Buffer (lower part) are as follows:
<br>
<img src="CompositorLayers/2022-04-19-13-56-47.png" alt="Detail Difference"></p>
<div class="CAUTION">
<h5>Caution</h5>
<p>Some dispersion can be seen in the detailed image, which is generated to offset the dispersion caused by the lens. Therefore, when using the device, not all dispersion will be seen.</p>
</div>
<h3 id="composition-layer-example">Composition Layer Example</h3>
<p>Please refer to the following example project.</p>
<ol>
<li><p>Open a new project or the current project.</p>
</li>
<li><p>Import the latest SDK.</p>
</li>
<li><p>In the Project panel, select <strong>Packages</strong> &gt; <strong>YVR Core</strong> &gt; <strong>Scenes</strong> &gt; <strong>CompositeLayer</strong>.</p>
</li>
<li><p>In the CompositeLayer folder, select <strong>CompositeLayer.unity</strong> to open the scene.</p>
</li>
<li><p>In <strong>File</strong> &gt; <strong>Build Settings...</strong>, select <strong>Add Open Scenes</strong>.</p>
</li>
<li><p>Select <strong>Build</strong> and name the file.</p>
</li>
<li><p>Install the APK file on the device.</p>
</li>
<li><p>This scene shows the effects of different depth values, dynamic and static images.
<br>
<img src="CompositorLayers/CompositeLayers.png" alt="CompositorLayers"></p>
</li>
</ol>
<h3 id="shape-and-rect-example">Shape and Rect Example</h3>
<p>Please refer to the following example project.</p>
<ol>
<li><p>Open a new project or the current project.</p>
</li>
<li><p>Import the latest SDK.</p>
</li>
<li><p>In the Project panel, select <strong>Packages</strong> &gt; <strong>YVR Core</strong> &gt; <strong>Scenes</strong> &gt; <strong>CompositeLayer</strong>.</p>
</li>
<li><p>In the CompositeLayer folder, select <strong>CompositeLayerShapeAndRect.unity</strong> to open the scene.</p>
</li>
<li><p>In <strong>File</strong> &gt; <strong>Build Settings...</strong>, select <strong>Add Open Scenes</strong>.</p>
</li>
<li><p>Select <strong>Build</strong> and name the file.</p>
</li>
<li><p>Install the APK file on the device.</p>
</li>
<li><p>This scene shows the effects of shape switching, setting source rectangles, and destination rectangles.
<br>
<img src="CompositorLayers/ShapeAndRect.png" alt="ShapeAndRect"></p>
</li>
</ol>
<h2 id="underlay-vs-overlay">Underlay vs Overlay</h2>
<p>Since the native system needs to composite multiple layers, it needs to know the order of all layers. This order is determined by the depth of the composition layer. The depth of the Unity Eye Buffer is set to 0. All layers with a depth greater than 0 are called Overlay, and layers with a depth less than 0 are called Underlay.</p>
<p>The bottom layer will be drawn first, followed by the Unity Eye Buffer, and finally the Overlay. Therefore, the Unity Eye Buffer will cover the Underlay, and the Overlay will cover the Eye Buffer.</p>
<p>To make the Underlay display normally and not be completely covered, a hole needs to be created in the Unity Eye Buffer. The shader <code>YVR/UnderlayPuncher</code> is designed to generate such a hole:
<br>
<img src="CompositorLayers/2022-04-19-14-58-37.png" alt="Underlay Puncher"></p>
<div class="TIP">
<h5>Tip</h5>
<p>The layer in the upper left corner of the example scene is Underlay.</p>
</div>

</article>

        <div class="contribution d-print-none">
          <a href="https://github.com/PlayForDreamDevelopers/com.yvr.core-mirror/blob/main/com.yvr.core/Documentation/AdvancedFeatures/CompositorLayers.md/#L1" class="edit-link">Edit this page</a>
        </div>

        <div class="next-article d-print-none border-top" id="nextArticle"></div>

      </div>

      <div class="affix">
        <nav id="affix"></nav>
      </div>
    </main>

    <div class="container-xxl search-results" id="search-results"></div>

    <footer class="border-top text-secondary">
      <div class="container-xxl">
        <div class="flex-fill">
          <span>Made with <a href="https://dotnet.github.io/docfx">docfx</a></span>
        </div>
      </div>
    </footer>
  </body>
</html>
